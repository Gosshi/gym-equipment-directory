# 計画書（SPOMAP：次ステージ改善）

## 目的
- SEO の基礎体力を完成させ、インデックス精度と CTR を向上させる
- 施設タイプ別の広告出し分けで収益化の初速を作る
- SPOMAP 独自の価値（情報量と使いやすさ）を強化し、継続利用を伸ばす

## 前提
- URL 構造（`/gyms/[区]/[施設名]`）の最適化は完了済み
- Phase 1 と Phase 2 を最優先で着手する

## 対象範囲
- フロントエンド（詳細ページ、SEO メタ、OGP、広告表示）
- データ整形・判定ロジック（施設タイプ、設備、スポーツ名）
- コンテンツ生成・検索 UI の拡張

## 実装優先度と計画

### Phase 1：SEO と技術基盤の仕上げ（最優先）
1. 構造化データ（パンくずリスト）の実装
   - 詳細ページに JSON-LD 形式のパンくずリストを追加
   - 階層化 URL を反映し、検索結果のリッチ表示を狙う
2. 動的タイトルの最適化（競技名を入れる）
   - `<title>` を施設タイプに応じて自動生成
   - 例: `施設名（体育館・卓球・バスケ） | 区名 | SPOMAP`
3. OGP 画像の API Route 化
   - `app/api/og/route.tsx` で生成
   - 既存のファイルベース OGP を使わず、Next.js の既知バグを回避

### Phase 2：マネタイズ（収益化）の実装
1. 施設タイプ別の広告出し分け（ベース実装）
   - 判定ロジック: `facility.type` / `facility.equipment` / `has_pool` など
   - コンポーネント化して詳細ページで表示切り替え
2. コンテキスト広告の初期レパートリー
   - ジム: 近隣民間 24h ジム
   - プール: スイムキャップ、ゴーグル
   - 体育館/アリーナ: スペースマーケット/インスタベース
   - 武道場: 子供向けスポーツスクール体験

### Phase 3：UX とコンテンツの強化
1. AI 説明文の自動生成
   - 面数、広さ、営業時間などの保有データを文章化
   - 詳細ページの「準備中」エリアを埋め、SEO テキストを増やす
2. 競技での絞り込み検索
   - 「バスケ」「バレー」「水泳」「卓球」などアイコン付きフィルタを追加
3. 個人利用日情報の掲載（難易度高）
   - 体育館/武道場の一般公開日カレンダーを表示
   - 取得方法と更新フローの設計が必要

## 実装指示（AI エディタ向け）
- URL: `/gyms/[区]/[施設名]` の階層構造を維持する
- OGP: `opengraph-image.tsx` は使用せず、`api/og` 経由で生成する
- 広告ロジック: 施設データを判定し、プール/ジム/アリーナ/武道場で出し分ける
- SEO: 詳細ページに JSON-LD のパンくずリストを追加する

## 成果物
- パンくず JSON-LD の実装
- 競技名入りタイトルの自動生成
- API Route での OGP 生成
- 施設タイプ別広告の出し分けコンポーネント
- （Phase 3）AI 説明文/競技フィルタ/個人利用日情報の設計資料

## 検証観点
- 主要詳細ページで JSON-LD が正しく出力される
- `<title>` が施設タイプと競技名を含んでいる
- OGP が API から生成され、既知エラーが再現しない
- 施設タイプに応じて広告が切り替わる

## リスクと対策
- 競技名の抽出が不正確: 表示用の辞書を用意し、段階的に精度改善
- OGP 生成のレスポンス遅延: キャッシュと軽量化を優先
- 広告の CTR 低下: 文言と配置を A/B テスト可能にする

## 次のアクション
- Phase 1 の実装スコープ確定
- 施設タイプ判定のルール定義（Phase 2）
- 競技フィルタの UI/データ設計（Phase 3）

## 広告リンク/UTM 設計（Phase 2 補足）

### UTM 方針
- `utm_source`: `spomap`
- `utm_medium`: `contextual_ad`
- `utm_campaign`: 施設タイプ（`gym` / `pool` / `hall` / `dojo`）
- `utm_content`: リンク識別子（例: `chocozap` / `spacemarket`）
- `utm_term`: 任意（商品名などの識別が必要な場合のみ）

### 施設タイプ別リンク（初期案）
#### ジム / トレーニング室
- チョコザップ（`utm_campaign=gym`, `utm_content=chocozap`）
- 24 時間ジム（`utm_campaign=gym`, `utm_content=anytime`）

#### プール
- スイムキャップ（楽天/Amazon）
- スイミングゴーグル（楽天/Amazon）
- アフィリエイト優先のため UTM は原則付与しない

#### 体育館 / アリーナ
- スペースマーケット（`utm_campaign=hall`, `utm_content=spacemarket`）
- インスタベース（`utm_campaign=hall`, `utm_content=instabase`）

#### 武道場
- 体験教室（`utm_campaign=dojo`, `utm_content=kodomo_booster`）

### 注意点
- アフィリエイトリンクはネットワーク規約を優先
- 提携先から UTM 指定がある場合はそちらを優先

## Phase 1 実装スコープ詳細

### 対象ファイル
- `frontend/app/gyms/[...slug]/page.tsx`
  - `generateMetadata` の `<title>` 最適化
  - JSON-LD パンくずリストの追加
- `frontend/app/api/og/route.tsx`
  - OGP API ルートの現状確認のみ（既に実装済み）
- （新規）SEO ヘルパー
  - 例: `frontend/app/gyms/[...slug]/seo.ts` または `frontend/src/lib/seo.ts`
  - タイトル用キーワード抽出/パンくず生成を集約

### 実装タスク
1. タイトル生成ロジック
   - 施設タイプ: `gym.category` または `gym.categories` から 1 件抽出
   - 競技名: `gym.hallSports` を優先し、`gym.equipments` から辞書マッピングで補完
   - 最大 3 件までに制限し、`（体育館・卓球・バスケ）` 形式で結合
   - 地域名: `gym.city` を優先（なければ `gym.prefecture`）し `|` 区切りで追加
2. パンくず JSON-LD
   - `BreadcrumbList` を追加（既存の `SportsActivityLocation` とは別タグ）
   - 階層構成案:
     - `ホーム` -> `/`
     - `施設検索` -> `/gyms`
     - `都道府県` -> `/gyms?pref=...`（ある場合のみ）
     - `市区町村` -> `/gyms?pref=...&city=...`（ある場合のみ）
     - `施設名` -> `/gyms/${gym.slug}`
3. OGP 生成の確認
   - 詳細ページは `/api/og?slug=...` を参照していることを確認
   - `opengraph-image.tsx` は新規追加しない

### 仕様メモ（初期辞書の例）
- `卓球台` -> `卓球`
- `バスケットゴール` -> `バスケ`
- `バレーボール` -> `バレー`
- `プール/競泳/水深` -> `水泳`
- `トレーニング` -> `トレーニング`

### 完了条件
- `<title>` が施設タイプと競技名を含む
- JSON-LD パンくずが詳細ページに出力される
- OGP が API Route 経由で生成される

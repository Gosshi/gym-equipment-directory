# Codex 向けプロンプト: PR-10 Ingestion自動化と差分検知

以下の指示を Codex に与え、PR-10（Ingestion自動化と差分検知）を実装させる。日本語で説明するが、コード・識別子は既存スタイルに合わせて英語で記述すること。

## スコープ（PR-10）
- 既存ソース（例: site_a, municipal）のスクレイプ→抽出→候補作成→承認までを **定期ジョブ化** する。
- **差分検知/重複排除** を実装し、`last_verified_at_cached` の自動更新を組み込む。
- **リトライ/バックオフ** と **メトリクス記録**（成功件数/失敗件数/鮮度）を追加する。
- 運用バッチとして CLI/スクリプトを整備し、OpenAPI の影響があれば更新する。

## 受入基準
- スケジューラ（例: cron/apscheduler/Celery beat 等）が設定され、定期実行でパイプラインが回る。
- 差分検知ロジックで「新規」「更新」「重複」の分類が行われ、不要な再承認が抑止される。
- 実行ごとにメトリクスが記録される（ログ or メトリクスエンドポイント）。失敗はリトライし、上限超過時にエラーを出力。
- `last_verified_at_cached` が承認時に最新化されることがテストで確認される。
- pytest で差分検知ロジック、ジョブフロー擬似実行、エラー時のリトライ挙動をカバーする。

## コードベースの位置
- パイプライン/バッチ: `scripts/`, `app/batch/` など既存バッチ配置に従う。
- サービス/リポジトリ: `app/services/`, `app/repositories/`
- CLI: `app/cli/` または `scripts/` 配下（既存 CLI に統合する方針があれば従う）。
- 設定: `.env` や `settings` モジュールにスケジュール/リトライ/メトリクス用の設定を追加。

## 実装手順
1. **スケジューラ導入/設定**
   - 既存のバッチ実行方法（例: CLI + cron）を確認し、定期実行設定を追加。
   - Docker/Compose で動かす場合はサービス定義やエントリポイントに反映。
2. **差分検知/重複排除**
   - 候補生成時に既存レコードと比較し、「新規」「更新」「重複」を分類するロジックを追加。
   - 更新検知時は既存レコードにマージ/上書きするか、候補としてキューイングするかの方針をコードコメントで明示。
3. **`last_verified_at_cached` 自動更新**
   - 承認時に鮮度を更新する処理をバッチに統合。既存 runner/CLI を再利用できる場合は呼び出しを追加。
4. **リトライ/バックオフとメトリクス**
   - スクレイプ/抽出での失敗に対し、指数バックオフ付きリトライを追加（回数/間隔は設定化）。
   - 成功/失敗/スキップ件数やエラーログをメトリクスとして記録（ログ出力 or 専用エンドポイント）。
5. **テスト（pytest）**
   - 差分検知ロジックの単体テスト（新規/更新/重複の分類）。
   - バッチフローの疑似実行（依存をモック）でリトライ/メトリクス更新を確認。
   - `last_verified_at_cached` が承認時に更新されることを検証。
6. **ドキュメント更新**
   - 実行手順/環境変数/スケジュールを README または適切なドキュメントに追記。

## 非機能ガイドライン
- Python 3.11、行長 100 文字以内、文字列はダブルクォート。
- Ruff のフォーマット/チェックに従い、変更は PR-10 に必要な最小限に留める。

# Codex 向けプロンプト: PR-07 ジム検索機能拡充（distance/nearby + pagination整合）

以下の指示を Codex に与え、PR-07（ジム検索機能拡充）を実装させる。日本語で説明するが、コード・識別子は既存スタイルに合わせて英語で記述すること。

## スコープ（PR-07）
- `/gyms/search` に **distance ソート** を追加し、地図/位置情報 UI に対応させる。
- **新規エンドポイント `/gyms/nearby`** を追加し、座標+半径での検索を提供する。
- **ページネーション応答の整合性** を取り、`has_more`/`total`/cursor など既存仕様との整合を図る。
- 可能であれば **ジオインデックスの追加を検討**（必須ではないが性能確認する）。

## 受入基準
- `/gyms/search` で `sort=distance` を指定すると距離昇順で返る（基点は指定必須、未指定時は 422）。
- `/gyms/nearby` が `lat`/`lng`/`radius`/`page`/`page_size` を受け取り、ページング付きで結果を返す。
- 既存の並び順やフィルタ（カテゴリ/フリーワード等）が後方互換を保つ。
- レスポンスに `has_more`（または cursor）、`total` が正しく含まれ、距離フィールドは単位を明示する。
- 上記エンドポイントの 200/422/404/境界ケースをカバーする pytest が追加・更新されている。

## コードベースの位置
- ルーター: `app/api/routes/`
- サービス/リポジトリ: `app/services/`, `app/repositories/`
- ページネーション/クエリ依存: `app/api/dependencies/pagination.py` ほか関連ユーティリティ
- スキーマ: `app/api/schemas/`
- ジオ計算/ユーティリティがあれば既存のものを再利用、なければ最小限で追加。

## 実装手順
1. **`/gyms/search` の distance ソート追加**
   - クエリで `lat`/`lng` を必須（`sort=distance` 時）としてバリデート。
   - サービス/リポジトリで距離計算（例: Haversine）を行い、ソートに利用する。
   - レスポンスに `distance`（単位: キロメートル等）を含める。
2. **`/gyms/nearby` の追加**
   - ルーター/スキーマを新設し、座標+半径で検索、ページングを実装。
   - radius デフォルト/上限を設定し、異常値は 422 を返す。
3. **ページネーション整合性**
   - `has_more`/`total`/cursor の計算を `/gyms/search` と `/gyms/nearby` で統一。
   - 既存 keyset/offset 仕様との矛盾がないようにする。
4. **エラーハンドリング**
   - 無効入力は 422、範囲外/存在しない場合は 404（該当ロジックがある場合）を返し、JSON 形状を揃える。
5. **テスト（pytest）**
   - distance ソートが正しく昇順になること、必須座標欠如で 422 となること。
   - `/gyms/nearby` が radius/ページング境界で期待どおり動作すること。
   - 既存検索機能との後方互換を確認するテストを追加/更新。
6. **DB マイグレーションは慎重に**
   - 性能に問題がある場合のみジオインデックス追加を検討し、必要なら Alembic で追加する（不要なら変更しない）。

## 非機能ガイドライン
- Python 3.11、行長 100 文字以内、文字列はダブルクォート。
- Ruff のフォーマット/チェックに従い、変更は PR-07 に必要な最小限に留める。

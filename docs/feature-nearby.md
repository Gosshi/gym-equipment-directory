# 近隣ジム検索 (MapLibre)

## 目的

ブラウザの現在地または任意で指定した座標を起点に、周辺のジムを地図上のピンと一覧の両方で確認できるようにします。MapLibre GL JS と OpenStreetMap タイルを利用し、追加の API キー不要な構成としています。

## 必要な環境変数

`.env.local` などフロントエンドの環境ファイルに以下を設定してください。

- `NEXT_PUBLIC_API_BASE` (既存の `NEXT_PUBLIC_API_BASE_URL` でも可): API のベース URL。例: `http://127.0.0.1:8000`
- `NEXT_PUBLIC_DEFAULT_CENTER`: 初期センター座標 (`緯度,経度` 形式)。例: `35.681236,139.767125`
- `NEXT_PUBLIC_DEFAULT_RADIUS`: 初期検索半径 (メートル)。例: `3000`

## 起動方法と API 通信

1. 必要に応じて AWS SSM トンネルを開き、API へアクセスできるようにします。
2. `NEXT_PUBLIC_API_BASE` にトンネル経由の URL (例: `http://127.0.0.1:8000`) を設定します。
3. `npm run dev` でフロントエンドを起動し、`/gyms/nearby` にアクセスすると地図と一覧が表示されます。

## 現在地取得と許可ハンドリング

- `useNearbySearchController` がブラウザの Geolocation API を検出し、利用可否を `location.status` と `location.hasResolvedSupport` に保持します。
- 初回は URL クエリに `lat` / `lng` が無い場合でも、`navigator.geolocation.getCurrentPosition` を試みます。拒否・失敗時は `location.error` にメッセージを保存し、ステータスバナーとトーストで通知します。
- 失敗理由ごとにメッセージを分岐させており、拒否・タイムアウト・非対応などで異なるテキストを表示します（例: 「位置情報が許可されていません。手動入力や地図から地点を選択してください。」）。
- 現在地の再取得は `location.status` を `loading` に切り替え、完了後に URL へ `lat` / `lng` / `radius_km` を書き戻します。成功時は `mode="auto"` として明示的入力との区別が付きます。

## 距離スライダーと検索条件

- 半径は 1km〜30km を 1km 刻みで選択でき、スライダーとセレクトの双方で同じ値を扱います。URL には `radiusKm`（互換で `radius_km`）として保持します。
- スライダー操作は 240ms デバウンスでリクエストを抑制し、`page` を 1 に戻したうえで `/gyms/nearby` API を再フェッチします。
- `SearchDistanceBadge` で現在の半径を常に表示し、マップ表示範囲と一覧対象が一致していることを明確にしています。
- 緯度・経度入力は 6 桁精度で固定され、無効値を送信すると `manualError` を表示して再入力を促します。

## ピン選択と右パネルの方針

- 地図上のピンは MapLibre の `Marker` をボタン化し、クリック・Enter で `onSelect` を発火させて右側の詳細パネル（`NearbyList` 内カード）をハイライトします。
- 地図上には吹き出し等の詳細情報を増やさず、選択ジムの概要は常に右パネルで表示します。`data-panel-anchor="pin"` を利用して選択ソースを追跡します。
- 一覧側の行を選択した場合も同じ `onSelect` が呼ばれ、マップのピンが強調表示されます。ピン強調は CSS クラスを差し替え、擬似ポップアップを使わないため視界が煩雑になりません。

## バウンス防止と自動パン制御

- 自動パンはピン選択後 120〜300ms の遅延で行い、`pendingPanRef` にタイマーを保持して連打時のバウンスを防ぎます。
- ユーザードラッグ中（`isUserInteractingRef` が `true`）は自動パンを抑止し、操作終了から 600ms 経過するまで地図中心を固定します。
- `resumePendingAutoPanRef` により、モーダルやクラスタ展開後に再パンが必要な場合のみ処理を再開します。
- URL 更新を伴うパンは `planNavigation` 経由で `pushState` され、ブラウザの戻る／進む操作で地図中心と半径が復元されます。

## 既知の制限・今後の改善候補

- 住所や駅名入力によるジオコーディングは未実装です。現在は緯度・経度の直接入力のみ対応しています。
- ピン数が多い場合のクラスタリングや、設備/料金などの詳細フィルタ連携は今後の拡張余地があります。
- タイルロードはインターネット接続に依存します。社内環境では外部ネットワーク接続の許可状態を確認してください。

## 関連ドキュメント

- [短期ロードマップ](./roadmap-next.md)
- [テスト戦略](./testing-strategy.md)
- [アクセシビリティ指針](./accessibility.md)
- [FE10 改善計画の進捗サマリー](./fe10-progress.md)

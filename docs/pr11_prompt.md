# Codex 向けプロンプト: PR-11 AdminモデレーションUX + 実行ログ

以下の指示を Codex に与え、PR-11（Admin モデレーション UX 強化と実行ログ追加）を実装させる。日本語で説明するが、コード・識別子は既存スタイルに合わせて英語で記述すること。

## スコープ（PR-11）
- Admin 候補一覧/詳細 API を強化し、**バルク承認・却下**をサポートする。
- 操作を **監査ログ/実行ログ** として永続化し、誰がいつどの候補を処理したかを記録する。
- レート制限やリトライ耐性を高め、冪等な処理フローを整備する。
- OpenAPI を更新し、フロント/CLI から利用できるようにする。

## 受入基準
- Admin API で複数 ID を指定した承認/却下が 200 で応答し、結果が永続化される。
- 監査ログに operator（トークン主体）、timestamp、candidate IDs、処理結果が保存される。
- 却下理由や dry-run の指定ができ、dry-run 時は DB が変更されない。
- 4xx/5xx が適切に返る（認可なし、入力不正、処理失敗）。
- pytest で承認/却下/監査ログ/エラーハンドリングのケースをカバーする。

## コードベースの位置
- ルーター: `app/api/routes/admin/`
- サービス/リポジトリ: `app/services/`, `app/repositories/`
- スキーマ: `app/api/schemas/`
- ログ/履歴テーブルが必要な場合は Alembic migration を追加（最小限）。

## 実装手順
1. **スキーマ/ルーター拡張**
   - バルク承認/却下エンドポイントを追加し、入力バリデーションを実装する（IDs, reason, dry_run）。
   - 既存エンドポイントと後方互換を保ちつつ、OpenAPI を更新する。
2. **サービス/リポジトリ**
   - トランザクション内で候補をまとめて処理し、冪等性を担保する（既承認はスキップ等）。
   - 監査ログを保存する仕組みを追加し、サービスから呼び出す。
3. **レート制限/エラーハンドリング**
   - 過剰操作を防ぐための簡易レート制限・リトライ対応を検討し、例外時は一貫した 4xx/5xx を返す。
4. **テスト（pytest）**
   - 正常: 単体/バルク承認・却下が成功し、監査ログが記録される。
   - 異常: 入力不正、未認可、既に処理済みの候補を含むケース、dry-run で DB が変化しないこと。
5. **マイグレーション判断**
   - ログテーブルが無い場合は Alembic migration を追加。不要であれば DB 変更は行わない。

## 非機能ガイドライン
- Python 3.11、行長 100 文字以内、文字列はダブルクォート。
- Ruff のフォーマット/チェックに従い、変更は PR-11 に必要な最小限に留める。

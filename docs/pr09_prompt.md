# Codex 向けプロンプト: PR-09 メタデータAPI整備（都道府県/市区/カテゴリ）

以下の指示を Codex に与え、PR-09（メタデータAPI整備）を実装させる。日本語で説明するが、コード・識別子は既存スタイルに合わせて英語で記述すること。

## スコープ（PR-09）
- セレクタ用メタデータ API を追加/整理する: `/meta/prefectures`, `/meta/cities`, `/meta/categories`。
- 旧パラメータ名への **後方互換キー変換** を行い、URL 復元時も破壊しない。
- キャッシュ戦略を導入（インメモリ or Redis など環境に合わせて最小限）。
- OpenAPI を更新し、Next.js から利用可能なスキーマを明確にする。

## 受入基準
- 上記 3 エンドポイントが 200 を返し、名称/コード/ソート順が安定している。
- `prefecture`/`city` クエリなど、旧キーが指定されても正しく新スキーマに変換される。
- キャッシュを導入し、TTL/無効化方針がドキュメントまたはコードコメントで明示される。
- 422/404 のバリデーション/エラー形状が既存 API と統一されている。
- pytest で 200/422/後方互換キーの動作をカバーし、OpenAPI が更新される。

## コードベースの位置
- ルーター: `app/api/routes/`
- サービス/リポジトリ: `app/services/`, `app/repositories/`
- スキーマ: `app/api/schemas/`
- キャッシュ層: 既存のユーティリティがあれば再利用、なければ最小限で追加（環境変数で切り替えられる構成を意識）。

## 実装手順
1. **スキーマ定義**
   - メタデータの Pydantic モデルを定義（コード, name, sort_order など）。
   - 後方互換キーの扱いをコメントで明示し、フロントの依存を整理。
2. **ルーター追加/更新**
   - `/meta/prefectures`, `/meta/cities`, `/meta/categories` を実装し、キャッシュ経由で返却。
   - city API は都道府県コードフィルタをサポートし、異常値は 422 とする。
3. **キャッシュ導入**
   - 可能なら簡易インメモリキャッシュを先行し、環境変数で TTL を指定。Redis 等がある場合は抽象化で差し替え可能に。
4. **後方互換キー変換**
   - 入力クエリの旧キーを新キーにマッピングし、互換性を維持。
5. **テスト（pytest）**
   - 正常系の 200 応答、旧キー→新キー変換、キャッシュが効いていることの簡易テスト。
   - バリデーション 422/存在しないコードの 404 をカバー。
6. **OpenAPI 更新**
   - 新エンドポイントとレスポンススキーマがドキュメント化されていることを確認し、必要なら `openapi.json` を再生成。

## 非機能ガイドライン
- Python 3.11、行長 100 文字以内、文字列はダブルクォート。
- Ruff のフォーマット/チェックに従い、変更は PR-09 に必要な最小限に留める。

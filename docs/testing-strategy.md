# テスト戦略

FE10 以降の開発では、回帰防止と検証コスト削減を両立するためにテスト階層を明示的に分担する。

## テスト階層と責務

- **単体テスト（Vitest / pytest）**
  - Zustand ストア、React Hooks、FastAPI の各ユーティリティ関数を対象とする。
  - URL クエリ生成や履歴復元など、純粋関数として検証できる部分はここで担保する。
- **統合テスト（React Testing Library / pytest + TestClient）**
  - フロントは `useGymSearch` とコンポーネントの組み合わせ、バックエンドはルータと DB の連携を検証する。
  - ページネーションと検索履歴の整合性は統合テストで再現し、ブラウザ依存の E2E に頼らない。
- **E2E テスト（Playwright）**
  - ユーザー導線のスモーク確認に限定する。検索導線の基本操作、地図の初期表示、主要 CTA の動作のみを対象とする。
  - 長時間のブラウザ操作を伴う回帰チェックは手動 QA と統合テストの組み合わせで代替する。

## 履歴 × ページングの検証指針

- URL `page` / `radius_km` / `lat` / `lng` の同期を単体テストで網羅する。
- 統合テストでは以下を重点確認する。
  - `pushState` → 検索結果 → `popstate` の往復でストアが期待どおり復元される。
  - ページング変更時にスクロール位置を初期化し、戻る操作で元に戻る。
  - `navigationSource` に応じたフォーカス制御が呼ばれる。
- フレーク防止のため、`setTimeout` や `requestAnimationFrame` をモックし、固定タイミングでアサーションする。

## 削除した E2E（search-history）の扱い

- 目的: 履歴同期とページングをブラウザ実行で検証していた。
- 現状: テスト時間短縮のため一旦削除。
- 方針: 上記の単体/統合テスト強化で同等の保証を確保した後、重要シナリオのみを再導入する。
  - 復活時は操作数を最小化し、CI 時間に影響を与えないようにする。

## 回帰チェックリスト（手動 QA）

- URL 履歴
  - 検索条件変更 → ブラウザ戻る → 条件が復元される。
  - 検索結果のカードを開閉した後でもページ番号が崩れない。
- ページネーション
  - `page=1` から `page=3` へ移動後、戻る操作で `page=2` → `page=1` と遷移する。
  - ページサイズ変更後に `page` が 1 に戻り、スクロール位置が結果リストの先頭に戻る。
- 近隣マップ
  - ズーム操作中は自動パンが抑止され、操作終了後に解除される。
  - 地図のドラッグ後にピンをクリックすると詳細パネルがフォーカスされる。

## ドキュメント連携

- 詳細な回帰観点は [短期ロードマップ](./roadmap-next.md) と [バックログ台帳](./backlog.md) を参照すること。
- 進捗や残タスクの棚卸しは [FE10 改善計画の進捗サマリー](./fe10-progress.md) を確認すること。

# Frontend Search Distance Filter

このページではジム検索の検索フォーム、ページネーション、現在地フィルタの仕様をまとめています。

## 検索全体像

- `/gyms/search` エンドポイントを利用し、Zustand の `useGymSearch` が URL クエリとフォーム状態の同期を一元管理します。
- クエリの変更は `history.pushState` で URL とストアを即時同期し、ブラウザの戻る／進む操作でフィルタが復元されます。
- 検索条件は共有 URL やリロードから復元でき、アクセシビリティ面ではスキップリンクと結果リストへのフォーカス制御を実装しています。

## URL クエリ仕様

### 共通パラメータ

- `page`: 1 始まりのページ番号。`setPage` による操作時はスクロール位置とフォーカスをリセットします。
- `limit`: 1 ページあたりの件数。UI のセレクトボックスは 10 / 20 / 50 を提示し、未指定時は 20 を使用します。
- `page_size` / `per_page`: 既存互換のシノニム。受信時は `limit` より優先して `page_size` → `per_page` → `limit` の順で採用し、URL へは `page_size` として書き戻します。
- `q`: フリーテキスト検索。空文字の場合はクエリから削除し、URL 共有時に不要なパラメータが残らないようにします。
- `category`: 設備カテゴリのスラッグ配列をカンマ区切りで保持します。複数選択時は配列順を固定し、再パース時の差分検知が容易になります。
- `pref`: 都道府県コード（例: `tokyo`, `chiba`）。`pref` が変更された場合は市区町村リストを再フェッチし、`city` が存在すればクリアします。
- `sort`: `recommended` / `score` / `review_count` などのソートキー。無指定時は API 既定値に合わせて `recommended` を利用します。
- その他の補助パラメータ（`city`, `distance`, `lat`, `lng`, `radius_km` など）は必要な場合のみ付与します。

### 位置情報系パラメータ

- 緯度・経度を利用する検索は `lat`・`lng`・`radius_km` を URL に含めます。
- `radius_km` は現在地が設定されている場合は常に書き出され、共有リンクから半径が復元されます。
- 既存の `page` や `page_size` などのページネーション情報と同じく `useGymSearch` がシリアライズ／パースを担当します。

## デフォルトとフォールバック

- 初回マウント時にクエリに `lat` / `lng` が無い場合は `navigator.geolocation.getCurrentPosition` で現在地の取得を試みます。
- 権限拒否・タイムアウト・API 非対応などで位置情報を取得できなかった場合は東京駅周辺（35.681236, 139.767125）をデフォルト地点として利用します。
- フォールバック時でも UI には半径スライダーの値が保持され、URL も同じ値で更新されます。

## UI の挙動

- スライダーの変更は 300ms のデバウンス後に検索結果を再フェッチし、`page` を 1 にリセットします。
- 「現在地を再取得」ボタンは取得中にスピナーを表示し、失敗時は警告アイコンとトースト（「位置情報が許可されていません。任意の地点を選ぶか、許可してください。」など）を表示します。
- 「デフォルト地点を使用」ボタンでフォールバック地点を明示的に適用できます。手動入力や「位置情報をクリア」も可能です。
- スライダーには `aria-label` を付与し、現在の半径をラベル横に表示してアクセシビリティを確保しています。

## デバウンスとリクエスト

- 検索条件（キーワード・カテゴリ・距離など）の変更は `useGymSearch` が 300ms のデバウンスでクエリを更新します。
- 位置情報が設定されている場合は API に `radiusKm` として渡され、`/gyms/search` が `radius_km` を受け取ります。
- ページネーションは距離変更時にリセットされ、`loadNextPage` などの既存挙動も維持されます。
- `pref` と `city` の組み合わせが変更された場合も `page` は 1 に戻し、一覧のスクロール位置とフォーカスを初期化します。

## ページネーション UX

- `GymList` はページ切り替え時に結果セクションへフォーカスを移し、スクリーンリーダー利用時に現在ページのコンテキストが伝わるよう `aria-live` と結果件数の説明を読み上げます。
- ページ変更後は前回のページ上部までスムーズスクロールし、同時に `useSearchStore` に記録したスクロール位置をクリアします。戻る操作時のみ `preventScroll` で元の位置を維持します。
- 結果が多い場合は仮想リスト（`VirtualizedGymGrid`）を利用し、フォーカス先のジムカードが DOM に挿入されるまで `requestAnimationFrame` でリトライします。
- ページ選択ボタンと件数セレクトには `aria-label` や `aria-describedby` を設定し、Tab 移動だけで操作できるようキーボードナビゲーションを確保しています。

## 権限失敗時の通知

- 位置情報取得に失敗した場合は `location.status === "error"` になり、トースト／バナーでユーザーに許可を促します。
- フォールバック地点を利用してもエラーステータスを維持することで警告アイコンを表示し続けます。

## 履歴同期とテスト

- フィルタ変更時は `useGymSearch` が `history.pushState` を呼び出し、URL と Zustand ストアを同期します。
- `popstate` 発火時はクエリを再パースしてフィルタと `navigationSource` を `"pop"` に戻し、保存したスクロール位置を復元します。
- `navigationSource` はページ送りで `"page"`、URL 直接編集で `"push"`、戻る／進むで `"pop"` を保持し、フォーカス制御の分岐に利用します。
- 単体テスト（Vitest）はモックした `popstate` でストア更新とナビゲーションソースの遷移を確認します。
- E2E テスト（Playwright）はフィルタ変更後にブラウザの戻る／進むを操作し、
  フォーム値と結果リストが履歴に追随することを検証します。

## ダミーデータ投入と検証フロー

- 開発環境では `alembic upgrade head` 後に `python -m scripts.seed` で基本データを投入します。
- ページネーションや大量データの挙動を確認する場合は `python -m scripts.seed_bulk --count 500` を実行し、最低 200 件以上のダミージムを作成します。
- `seed_bulk` 実行後は `/gyms/search?page=1&page_size=50` などの URL でリスト件数を確認し、ページ送りと履歴復元が想定どおりに動作するか検証します。
- ダミーデータ投入はローカル DB のみに行い、本番互換環境では必ず事前にメンテナンスチームと調整してください。

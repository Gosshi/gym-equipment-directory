# Web検索ページ (/gyms, /gyms/search)

ジム一覧ページでは、利用者が設備カテゴリやエリアを組み合わせた検索を行い、その条件を URL クエリに同期することで同じ結果を簡単に再現・共有できるようになっています。本書では UI の振る舞いと URL パラメータ仕様、既知の制限事項をまとめます。

## フィルタ UI

- **キーワード**: フリーテキストで名称・設備名を部分一致検索します。300ms のデバウンス後に URL と API クエリを更新します。
- **都道府県 / 市区町村**: 2 段階のドロップダウン。都道府県選択時に対応する市区町村候補を取得し、キャッシュします。都道府県を変更すると市区町村はクリアされます。
- **設備カテゴリ**: チップ型のチェックボックスで複数選択に対応。最大 6 件をカードに表示します。
- **並び順**: `distance` / `popular` / `fresh` / `newest` の 4 種類。`distance` 選択時は現在 API ソートに反映されず保持のみ行います。
- **距離スライダー**: 1〜30km を 1km 刻みで指定。将来的な近隣検索との連携を想定し、現時点ではクライアント側での状態保持のみです。
- **条件をクリア**: 現在のページサイズを維持したまま、すべてのフィルタを初期状態に戻します。

## 結果リストとページネーション

- **番号式ページネーション**: ページ番号を 5 件前後表示し、前後のページへ直接移動できます。境界では「…」を表示し範囲を省略します。
- **ページング制御**: 件数選択は 20 / 40 / 60 件。URL の `page`・`limit` を同期しつつ API を再取得します。
- **無限スクロール**: IntersectionObserver で結果末尾に達した際に `loadNextPage` を呼び、次ページを自動取得して既存リストに重複なく追加します。ローディング中は「読み込み中...」のテキストを表示します。
- **フォーカス管理**: ページ番号を操作した際は検索結果セクションへフォーカスを戻し、キーボード操作でも文脈を見失わないようにしています。

## URL パラメータ

| キー | 役割 | 例 |
| --- | --- | --- |
| `q` | キーワード | `q=bench` |
| `pref` | 都道府県スラッグ | `pref=tokyo` |
| `city` | 市区町村スラッグ | `city=shinjuku` |
| `cats` | 設備カテゴリ CSV | `cats=squat-rack,dumbbell` |
| `sort` | 並び順 (`distance`/`popular`/`fresh`/`newest`) | `sort=newest` |
| `page` | 表示ページ (1 始まり) | `page=2` |
| `limit` | 1 ページの件数 (1〜50) | `limit=40` |
| `distance` | スライダーで指定した距離 (km) | `distance=10` |

不正な値は既定値にフォールバックされ、空値はパラメータごと削除されます。`prefecture`、`per_page`、`equipment` といった旧形式のキーも後方互換のため解釈します。

## ページングと API

- クライアントは `page` と `limit` を URL から復元し、検索 API `/gyms/search` へは `per_page` に変換して送信します。
- API のレスポンス `total` と `has_next` を用いてページネーション UI を制御します。`total` が取得できない場合は現在のページと `has_next` をもとにページ数を推定します。
- 無限スクロールでは `loadNextPage()` がページ番号を 1 つ進めた URL を push し、戻り値の `items` を重複排除しながら既存リストに追加します。
- 1 ページあたりの件数は 20 / 40 / 60 から選択可能です。

## 状態同期とキャッシュ

- フィルタ変更は 300ms のデバウンス後に URL を `router.push` で更新します。ページ番号・件数変更時は即時反映します。
- 都道府県ごとの市区町村一覧は取得後にメモリキャッシュし、同じ組み合わせでは再フェッチを避けます。再読み込みボタンでキャッシュを明示的に破棄できます。
- 検索結果はフェッチ中にカードのスケルトンを表示し、API エラー時はリトライボタンを提示します。

## 既知の制限

- 距離スライダーは現状 UI 上の保持のみで、API には送信されません。
- `distance` 並び順は UI の選択状態を維持しますが、API 側で距離ソートが提供されるまでは `score` (人気順) が継続利用されます。
- 市区町村一覧は都道府県選択時にのみ取得するため、先に市区町村を直接指定した URL を開く場合、一度都道府県を選び直すと選択肢が復元されます。
- 無限スクロールで複数ページを読み込んだ状態でページを再読み込みすると、直近に到達していたページから再開し、過去ページの結果は再ロードされません。

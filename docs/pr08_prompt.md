# Codex 向けプロンプト: PR-08 ジム詳細APIリッチ化

以下の指示を Codex に与え、PR-08（ジム詳細APIリッチ化）を実装させる。日本語で説明するが、コード・識別子は既存スタイルに合わせて英語で記述すること。

## スコープ（PR-08）
- `/gyms/{slug}` のレスポンスに **画像ギャラリー**（URL/alt/並び順）を含める。
- **設備詳細**（カテゴリ分け、表示名、主要な属性）を拡充し、欠損時のプレースホルダーを定義する。
- `last_verified_at_cached` を詳細応答へ追加し、鮮度の可視化を行う。
- 関連カテゴリ/設備のソートルールを整理し、一貫した順序で返す。
- 既存フィールドとの後方互換を保ちつつ、OpenAPI を更新する。

## 受入基準
- `/gyms/{slug}` が 200 で返す JSON に `images`, `equipments`（カテゴリ/名称/属性）, `last_verified_at_cached` が含まれる。
- 画像・設備データが存在しない場合もレスポンス形状を固定し、プレースホルダー値を返す（空配列、null などを明示）。
- 関連設備がカテゴリ→名称で安定したソートになる。
- 404（存在しない slug）と入力不正の 422 を適切に返す。
- OpenAPI 仕様が更新され、pytest で 200/404/422/欠損データのケースをカバーする。

## コードベースの位置
- ルーター: `app/api/routes/`
- サービス/リポジトリ: `app/services/`, `app/repositories/`
- スキーマ: `app/api/schemas/`
- 画像/設備関連の補助テーブルが必要な場合は Alembic migration を追加（最小限）。

## 実装手順
1. **スキーマ拡張**
   - Pydantic レスポンスモデルに `images`（url, alt, sort_order など）と設備詳細フィールドを追加。
   - `last_verified_at_cached` を公開フィールドに含め、型/フォーマットを明示。
2. **リポジトリ/サービス更新**
   - `slug` でジムを取得する際に画像・設備を JOIN/プレロードする。
   - カテゴリ/名称でソートし、欠損は空配列/None で返す。
3. **ルーター/エラーハンドリング**
   - 404/422 のレスポンス形状を統一し、既存仕様との後方互換を確認。
4. **OpenAPI 更新**
   - 新規フィールドがドキュメントに出ることを確認し、必要なら `openapi.json` を再生成。
5. **テスト（pytest）**
   - 正常系: 画像/設備/鮮度フィールドが期待どおり含まれる。
   - 欠損データ: 画像なし/設備なしでレスポンス形状が崩れない。
   - 404/422 のバリデーションをカバー。
6. **マイグレーション判断**
   - 既存テーブルで足りない場合のみ Alembic migration で列/テーブルを追加。不要なら DB 変更は行わない。

## 非機能ガイドライン
- Python 3.11、行長 100 文字以内、文字列はダブルクォート。
- Ruff のフォーマット/チェックに従い、変更は PR-08 に必要な最小限に留める。
